name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_REGISTRY: registry.ryein.kim
  DOCKER_IMAGE_NAME: music-bot

jobs:
  # ========================================
  # Job 1: Code Quality & Testing
  # ========================================
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest black

      - name: Lint with flake8
        continue-on-error: true
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        continue-on-error: true
        run: |
          black --check --diff .

      - name: Run basic syntax check
        run: |
          python -m py_compile musicbot.py

  # ========================================
  # Job 2: Build Docker Image (Multi-platform)
  # ========================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'release'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Private Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDTIME=${{ github.event.head_commit.timestamp }}
            VERSION=${{ github.ref_name }}
            REVISION=${{ github.sha }}

      - name: Image digest
        run: echo ${{ steps.meta.outputs.digest }}

      - name: Image summary
        run: |
          echo "## ðŸ“¦ Docker Image Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.DOCKER_REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
  
  notifications:
    name: Discord Deployment Notification
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Discord Deployment Notification
        if: success()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_TITLE=$(echo "$COMMIT_MSG" | head -n 1)
          
          curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "username": "Music Bot CI/CD",
                "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "embeds": [{
                  "title": "ðŸš€ New Version Deployed",
                  "description": "'"$COMMIT_TITLE"'",
                  "color": 3066993,
                  "fields": [
                    {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                    {"name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true},
                    {"name": "Author", "value": "${{ github.actor }}", "inline": true},
                    {"name": "Image", "value": "`registry.ryein.kim/music-bot:latest`", "inline": false},
                    {"name": "Pull Command", "value": "```bash\ndocker pull registry.ryein.kim/music-bot:latest\n```", "inline": false}
                  ],
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                }]
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}